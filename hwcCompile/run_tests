#! /bin/bash



attempt=0
passed=0

for TESTCASE in $(ls -1 testcode/*.debug.* | grep -v test_out | grep -v FAIL)
do
  attempts=$((attempts+1))

  phase=$(echo $TESTCASE | rev | cut -f1 -d'.' | rev)
  base=$(echo $TESTCASE | rev | cut -f3- -d'.' | rev)

  rm $base.debug.$phase.* 2>/dev/null

  ./hwcCompile --debug=$phase < $base.hwc > $base.debug.$phase.test_out 2>&1
  rc=$?

  if [[ $rc != 0 ]]
  then
    echo "Testcase $TESTCASE failed, rc=$rc."
    mv $base.debug.$phase.test_out $base.debug.$phase.FAIL_rc_$rc
    continue
  fi

  if [[ $(diff $base.debug.$phase $base.debug.$phase.test_out) != "" ]]
  then
    echo "Testcase $TESTCASE failed."
    diff $base.debug.$phase $base.debug.$phase.test_out 1>&2

    mv $base.debug.$phase.test_out $base.debug.$phase.FAIL
    continue
  fi

  rm $base.debug.$phase.test_out

  attempts=$((attempts+1))
done

