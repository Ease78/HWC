#! /bin/bash


if [[ $* == "" ]]
then
  search=testcode/
else
  search=$*
fi



attempted=0
passed=0

for TESTCASE in $(find $search -name *.debug.* | grep -v test_out | grep -v FAIL)
do
  attempted=$((attempted+1))

  phase=$(echo $TESTCASE | rev | cut -f1 -d'.' | rev)
  base=$(echo $TESTCASE | rev | cut -f3- -d'.' | rev)

  rm $base.debug.$phase.* 2>/dev/null

  {
    ./hwcCompile --debug=$phase < $base.hwc
    rc=$?

    echo
    echo rc=$rc
  } > $base.debug.$phase.test_out 2>&1

  if [[ -f $base.wire ]]
  then
    echo "Testcase $TESTCASE failed: the .wire file was created."
    mv $base.debug.$phase.test_out $base.debug.$phase.FAIL
    mv $base.wire                  $base.debug.$phase.FAIL_wire
    continue
  fi

  if [[ $(diff $base.debug.$phase $base.debug.$phase.test_out) != "" ]]
  then
    echo "Testcase $TESTCASE failed."
      #diff $base.debug.$phase $base.debug.$phase.test_out 1>&2

    mv $base.debug.$phase.test_out $base.debug.$phase.FAIL
    continue
  fi

  rm $base.debug.$phase.test_out

  passed=$((passed+1))
done


for TESTCASE in $(find $search -name *.expect_fail | grep -v test_out | grep -v FAIL)
do
  attempted=$((attempted+1))

  base=$(echo $TESTCASE | rev | cut -f2- -d'.' | rev)

  rm $base.expect_fail.* 2>/dev/null

  {
    ./hwcCompile < $base.hwc
    rc=$?

    echo
    echo rc=$?
  } > $base.expect_fail.test_out 2>&1

  if [[ -f $base.wire ]]
  then
    echo "Testcase $TESTCASE failed: the .wire file was created."
    mv $base.expect_fail.test_out $base.expect_fail.FAIL
    mv $base.wire                 $base.expect_fail.FAIL_wire
    continue
  fi

  if [[ $(diff $base.expect_fail $base.expect_fail.test_out) != "" ]]
  then
    echo "Testcase $TESTCASE failed."
      #diff $base.expect_fail $base.expect_fail.test_out 1>&2

    mv $base.expect_fail.test_out $base.expect_fail.FAIL
    continue
  fi

  rm $base.expect_fail.*

  passed=$((passed+1))
done



if [[ $attempted = 0 ]]
then
  echo "ERROR: No testcases found!  Please check your search parameters!" 1>&2
  echo "       Current Search: $search" 1>&2
  exit 1
fi

echo
echo "$0: Testing completed. $attempted testcases attempted, $passed passed, $((passed*100/attempted))%"


